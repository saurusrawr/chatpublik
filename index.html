<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat Room - By Saurus</title>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

    :root {
      --primary: #7B2CBF;
      --accent: #9D4EDD;
      --light: #E0AAFF;
      --bg: linear-gradient(135deg, #240046 0%, #3C096C 50%, #7B2CBF 100%);
      --owner: #FFD700;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body { 
      font-family: 'Poppins', sans-serif;
      background: var(--bg);
      color: var(--light);
      min-height: 100vh;
      background-attachment: fixed;
      overflow: hidden;
    }

    .screen { 
      position: absolute; inset: 0; 
      display: flex; flex-direction: column; 
      transition: opacity .5s ease; 
    }
    .screen.hidden { opacity: 0; pointer-events: none; }

    .box { 
      background: rgba(255,255,255,0.12);
      backdrop-filter: blur(15px);
      padding: 50px 40px;
      border-radius: 25px;
      max-width: 480px;
      width: 90%;
      margin: auto;
      text-align: center;
      box-shadow: 0 15px 40px rgba(0,0,0,0.5);
    }

    h1 { font-size: 3.2rem; margin-bottom: 20px; background: linear-gradient(90deg, var(--light), white); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    input { width: 100%; padding: 16px; margin: 15px 0; border: 2px solid var(--primary); border-radius: 15px; font-size: 1.2rem; background: rgba(255,255,255,0.08); color: white; }
    button { background: var(--accent); color: white; padding: 16px; border: none; border-radius: 15px; font-size: 1.2rem; cursor: pointer; transition: all .3s; }
    button:hover { transform: scale(1.05); box-shadow: 0 8px 25px rgba(157,78,221,0.6); }

    .header { 
      background: rgba(0,0,0,0.45);
      padding: 18px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid var(--primary);
    }

    #daftar-room { padding: 25px; overflow-y: auto; flex: 1; }
    .room-item { 
      background: rgba(255,255,255,0.1);
      padding: 20px;
      margin: 15px 0;
      border-radius: 18px;
      cursor: pointer;
      transition: all .3s;
    }
    .room-item:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(123,44,191,0.4); }
    .delete-btn { background: #ff4757; font-size: 0.9rem; padding: 8px 16px; margin-top: 10px; }

    #pesan-container { 
      flex: 1;
      overflow-y: auto;
      padding: 25px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .pesan { 
      max-width: 80%;
      padding: 12px 18px;
      border-radius: 20px;
      position: relative;
    }
    .pesan.kirim { background: var(--primary); align-self: flex-end; }
    .pesan.terima { background: rgba(255,255,255,0.15); align-self: flex-start; }
    .pesan .pengirim { font-size: 0.9rem; opacity: 0.8; display: block; margin-bottom: 6px; }
    .pesan img { max-width: 100%; border-radius: 14px; margin-top: 8px; }
    .pesan audio { margin-top: 8px; width: 100%; max-width: 320px; }
    .owner-badge { 
      background: var(--owner);
      color: #000;
      font-size: 0.8rem;
      padding: 3px 10px;
      border-radius: 15px;
      margin-left: 10px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(255,215,0,0.5);
    }

    .input-area { 
      background: rgba(0,0,0,0.5);
      padding: 16px;
      display: flex;
      gap: 12px;
      position: sticky;
      bottom: 0;
    }
    #input-pesan { flex: 1; border-radius: 30px; background: rgba(255,255,255,0.2); color: white; padding: 14px; border: none; }
    #kirim, .attach, #rekam { 
      width: 54px; height: 54px; border-radius: 50%; border: none; 
      background: var(--accent); color: white; font-size: 1.4rem; cursor: pointer; 
    }
    .attach { background: var(--primary); display: grid; place-items: center; }

    .rekam-ui { 
      position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.8); padding: 16px 30px; border-radius: 40px;
      display: flex; gap: 20px; align-items: center; box-shadow: 0 6px 20px rgba(0,0,0,0.6);
    }
    .modal { display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.7); position: fixed; inset: 0; z-index: 10; }
    .modal.hidden { display: none; }
  </style>
</head>
<body>

<div id="login" class="screen">
  <div class="box">
    <h1>Chat Room</h1>
    <p style="margin:15px 0; opacity:0.9;">By Saurus</p>
    <input type="text" id="nama" placeholder="Nama kamu...">
    <button onclick="masuk()">Masuk</button>
  </div>
</div>

<div id="dashboard" class="screen hidden">
  <div class="header">
    <h2>Daftar Room</h2>
    <button onclick="keluar()">Logout</button>
  </div>
  <input type="text" id="cari" placeholder="Cari nama room..." oninput="cariRoom()">
  <button onclick="tampilBuat()">+ Buat Room Baru</button>
  <div id="daftar-room"></div>
</div>

<div id="form-buat" class="modal hidden">
  <div class="box">
    <h3>Buat Room Baru</h3>
    <input type="text" id="nama-room" placeholder="Nama Room">
    <input type="password" id="pw-room" placeholder="Password (kosong = tanpa)">
    <input type="number" id="max-anggota" placeholder="Max anggota (kosong = tak terbatas)" min="1">
    <div style="display:flex; gap:12px; margin-top:20px;">
      <button onclick="buatRoom()">Buat</button>
      <button onclick="sembunyiBuat()">Batal</button>
    </div>
  </div>
</div>

<div id="chat" class="screen hidden">
  <div class="header">
    <button onclick="kembali()">‚Üê</button>
    <h2 id="nama-room-saatini">Room</h2>
  </div>
  <div id="pesan-container"></div>
  <div class="input-area">
    <input type="text" id="input-pesan" placeholder="Ketik pesan...">
    <button id="kirim">‚û§</button>
    <label class="attach">üì∑ <input type="file" id="upload-gambar" accept="image/*" hidden></label>
    <button id="rekam">üé§</button>
  </div>
  <div id="rekam-ui" class="hidden">
    <span>Merekam...</span>
    <button id="stop-rekam">Stop</button>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBer_DF3-zAyH2rmnMpzilUiE5BYTb4In0",
    authDomain: "saurusproject-6974b.firebaseapp.com",
    databaseURL: "https://saurusproject-6974b-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "saurusproject-6974b",
    storageBucket: "saurusproject-6974b.appspot.com",
    messagingSenderId: "519472343742",
    appId: "1:519472343742:web:xxxxxxxxxxxxxxxx" // Ganti kalau punya
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();

  let namaUser = '';
  let isOwner = false;
  let roomSaatIni = null;
  let sedangRekam = false;
  let recorder, chunksAudio = [];
  let currentListener = null;

  // Login & cek owner mode (rahasia)
  function masuk() {
    namaUser = document.getElementById('nama').value.trim();
    if (!namaUser) return alert('Nama wajib diisi!');

    // Mode owner: cek pola {khusus:namanya}
    isOwner = namaUser.match(/\{khusus:.*\}/i) !== null;
    if (isOwner) namaUser = namaUser.replace(/\{khusus:|\}/gi, '').trim(); // bersihkan kode

    auth.signInAnonymously().then(() => {
      document.getElementById('login').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      tampilDaftarRoom();
    }).catch(err => alert('Gagal masuk: ' + err.message));
  }

  // Logout
  function keluar() {
    if (confirm('Yakin logout?')) auth.signOut().then(() => location.reload());
  }

  // Tampil daftar room
  function tampilDaftarRoom(kata = '') {
    db.ref('rooms').once('value').then(snapshot => {
      const list = document.getElementById('daftar-room');
      list.innerHTML = '';
      const rooms = snapshot.val() || {};

      Object.keys(rooms).forEach(id => {
        const r = rooms[id];
        if (kata && !r.nama.toLowerCase().includes(kata.toLowerCase())) return;

        const div = document.createElement('div');
        div.className = 'room-item';
        div.innerHTML = `<strong>${r.nama}</strong><br><small>Max: ${r.max || '‚àû'}</small>`;
        div.onclick = () => gabungRoom(id, r.password);

        if (isOwner) {
          const del = document.createElement('button');
          del.innerText = 'Hapus Room';
          del.className = 'delete-btn';
          del.onclick = e => { e.stopPropagation(); if (confirm('Hapus room ini?')) db.ref('rooms/' + id).remove(); };
          div.appendChild(del);

          const pwBtn = document.createElement('button');
          pwBtn.innerText = 'Lihat Password';
          pwBtn.onclick = e => { e.stopPropagation(); alert('Password: ' + (r.password || 'Tidak ada')); };
          div.appendChild(pwBtn);
        }

        list.appendChild(div);
      });
    });
  }

  function cariRoom() {
    tampilDaftarRoom(document.getElementById('cari').value);
  }

  // Buat room
  function tampilBuat() {
    document.getElementById('form-buat').classList.remove('hidden');
  }
  function sembunyiBuat() {
    document.getElementById('form-buat').classList.add('hidden');
  }

  function buatRoom() {
    const nama = document.getElementById('nama-room').value.trim();
    const pw = document.getElementById('pw-room').value;
    const max = parseInt(document.getElementById('max-anggota').value) || null;

    if (!nama) return alert('Nama room wajib!');

    const id = db.ref('rooms').push().key;
    db.ref('rooms/' + id).set({
      nama,
      password: pw || null,
      max,
      dibuat: firebase.database.ServerValue.TIMESTAMP
    });

    sembunyiBuat();
    tampilDaftarRoom();
  }

  // Join room
  function gabungRoom(id, pw) {
    if (pw) {
      const input = prompt('Masukkan password room:');
      if (input !== pw) return alert('Password salah!');
    }

    document.getElementById('pesan-container').innerHTML = '';
    if (currentListener) currentListener.off();

    roomSaatIni = id;
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('chat').classList.remove('hidden');
    document.getElementById('nama-room-saatini').textContent = 'Room: ' + id;

    const ref = db.ref('rooms/' + id + '/pesan');
    currentListener = ref;

    ref.on('child_added', snapshot => {
      tambahPesan(snapshot.val());
    });
  }

  function kembali() {
    roomSaatIni = null;
    if (currentListener) currentListener.off();
    document.getElementById('chat').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    tampilDaftarRoom();
  }

  function tambahPesan(msg) {
    const div = document.createElement('div');
    div.className = `pesan ${msg.pengirim === namaUser ? 'kirim' : 'terima'}`;

    let pengirim = msg.pengirim;
    if (msg.pengirim.match(/\{khusus:.*\}/i)) {
      pengirim += ' <span class="owner-badge">OWNER</span>';
    }

    let isi = `<span class="pengirim">${pengirim} ‚Ä¢ ${new Date(msg.waktu).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'})}</span>`;
    
    if (msg.tipe === 'teks') isi += msg.isi;
    else if (msg.tipe === 'gambar') isi += `<img src="${msg.isi}" alt="Gambar">`;
    else if (msg.tipe === 'suara') isi += `<audio controls src="${msg.isi}"></audio>`;
    
    div.innerHTML = isi;
    document.getElementById('pesan-container').appendChild(div);
    document.getElementById('pesan-container').scrollTop = document.getElementById('pesan-container').scrollHeight;
  }

  // Kirim teks
  document.getElementById('kirim').onclick = () => {
    const teks = document.getElementById('input-pesan').value.trim();
    if (!teks) return;
    db.ref('rooms/' + roomSaatIni + '/pesan').push({
      pengirim: namaUser,
      tipe: 'teks',
      isi: teks,
      waktu: firebase.database.ServerValue.TIMESTAMP
    });
    document.getElementById('input-pesan').value = '';
  };

  document.getElementById('input-pesan').onkeypress = e => {
    if (e.key === 'Enter') document.getElementById('kirim').click();
  };

  // Gambar
  document.getElementById('upload-gambar').onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const ref = storage.ref('gambar/' + Date.now() + '_' + file.name);
    ref.put(file).then(() => ref.getDownloadURL()).then(url => {
      db.ref('rooms/' + roomSaatIni + '/pesan').push({
        pengirim: namaUser,
        tipe: 'gambar',
        isi: url,
        waktu: firebase.database.ServerValue.TIMESTAMP
      });
    });
  };

  // Voice note
  document.getElementById('rekam').onclick = async () => {
    if (sedangRekam) return;
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recorder = new MediaRecorder(stream);
      chunksAudio = [];

      recorder.ondataavailable = e => chunksAudio.push(e.data);
      recorder.onstop = async () => {
        const blob = new Blob(chunksAudio, { type: 'audio/webm' });
        const ref = storage.ref('suara/' + Date.now() + '.webm');
        await ref.put(blob);
        const url = await ref.getDownloadURL();

        db.ref('rooms/' + roomSaatIni + '/pesan').push({
          pengirim: namaUser,
          tipe: 'suara',
          isi: url,
          waktu: firebase.database.ServerValue.TIMESTAMP
        });
      };

      recorder.start();
      sedangRekam = true;
      document.getElementById('rekam-ui').classList.remove('hidden');

      document.getElementById('stop-rekam').onclick = () => {
        recorder.stop();
        sedangRekam = false;
        document.getElementById('rekam-ui').classList.add('hidden');
      };
    } catch (err) {
      alert('Gagal akses mikrofon: ' + err.message);
    }
  };
</script>
</body>
</html>
