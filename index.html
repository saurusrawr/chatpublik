<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat Room Global - Saurus</title>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: system-ui, sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); color:#fff; height:100vh; overflow:hidden; display:flex; flex-direction:column; }
    .screen { position:absolute; inset:0; display:flex; flex-direction:column; transition:opacity .4s; }
    .screen.hidden { opacity:0; pointer-events:none; }
    .box { background:rgba(255,255,255,.15); backdrop-filter:blur(10px); padding:40px; border-radius:20px; max-width:400px; margin:auto; text-align:center; }
    input, button { width:100%; padding:14px; margin:12px 0; border:none; border-radius:10px; font-size:1.1rem; }
    button { background:#4ade80; color:#fff; cursor:pointer; }
    .header { background:rgba(0,0,0,.4); padding:16px; display:flex; justify-content:space-between; align-items:center; }
    #daftar-room { padding:20px; overflow-y:auto; flex:1; }
    .room-item { background:rgba(255,255,255,.1); padding:16px; margin:10px 0; border-radius:12px; cursor:pointer; }
    .room-item:hover { background:rgba(255,255,255,.2); }
    #pesan-container { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:12px; }
    .pesan { max-width:75%; padding:10px 14px; border-radius:18px; position:relative; }
    .pesan.kirim { background:#4ade80; color:black; align-self:flex-end; }
    .pesan.terima { background:rgba(255,255,255,.2); align-self:flex-start; }
    .pesan .pengirim { font-size:.8rem; opacity:.7; display:block; margin-bottom:4px; }
    .pesan img { max-width:100%; border-radius:10px; margin-top:6px; }
    .pesan audio { margin-top:6px; width:100%; max-width:280px; }
    .owner-badge { background:#ff6b6b; color:white; font-size:0.7rem; padding:2px 8px; border-radius:12px; margin-left:8px; }
    .input-area { background:rgba(0,0,0,.4); padding:12px; display:flex; gap:10px; position:sticky; bottom:0; }
    #input-pesan { flex:1; border-radius:24px; background:rgba(255,255,255,.25); color:#fff; padding:12px; border:none; }
    #kirim, .attach, #rekam { width:48px; height:48px; border-radius:50%; border:none; background:#4ade80; color:#fff; font-size:1.3rem; cursor:pointer; }
    .attach { background:#6b7280; display:grid; place-items:center; }
    .rekam-ui { position:fixed; bottom:70px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.7); padding:12px 24px; border-radius:30px; display:flex; gap:16px; }
    .hidden { display:none !important; }
  </style>
</head>
<body>

<div id="login" class="screen">
  <div class="box">
    <h1>Chat Global Saurus</h1>
    <input type="text" id="nama" placeholder="Nama kamu... (ketik saurus untuk owner mode)" autofocus>
    <button onclick="masuk()">Masuk</button>
  </div>
</div>

<div id="dashboard" class="screen hidden">
  <div class="header">
    <h2>Daftar Room</h2>
    <button onclick="keluar()">Logout</button>
  </div>
  <input type="text" id="cari" placeholder="Cari nama room..." oninput="cariRoom()">
  <button onclick="tampilBuatRoom()">+ Buat Room Baru</button>
  <div id="daftar-room"></div>
</div>

<!-- Form Buat Room -->
<div id="form-buat" class="modal hidden">
  <div class="box">
    <h3>Buat Room Baru</h3>
    <input type="text" id="nama-room" placeholder="Nama Room">
    <input type="password" id="pw-room" placeholder="Password (kosong = bebas)">
    <input type="number" id="max-anggota" placeholder="Maks anggota (kosong = tak terbatas)" min="1">
    <div style="display:flex; gap:10px;">
      <button onclick="buatRoom()">Buat</button>
      <button onclick="sembunyiBuatRoom()">Batal</button>
    </div>
  </div>
</div>

<!-- Chat Room -->
<div id="chat" class="screen hidden">
  <div class="header">
    <button onclick="kembaliDashboard()">‚Üê</button>
    <h2 id="nama-room-saatini">Room</h2>
  </div>
  <div id="pesan-container"></div>
  <div class="input-area">
    <input type="text" id="input-pesan" placeholder="Ketik pesan...">
    <button id="kirim">‚û§</button>
    <label class="attach">üì∑ <input type="file" id="upload-gambar" accept="image/*" hidden></label>
    <button id="rekam">üé§</button>
  </div>
  <div id="rekam-ui" class="rekam-ui hidden">
    <span>Merekam...</span>
    <button id="stop-rekam">Stop</button>
  </div>
</div>

<script>
  // === CONFIG FIREBASE KAMU ===
  const firebaseConfig = {
    apiKey: "AIzaSyBer_DF3-zAyH2rmnMpzilUiE5BYTb4In0",
    authDomain: "saurusproject-6974b.firebaseapp.com",
    databaseURL: "https://saurusproject-6974b-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "saurusproject-6974b",
    storageBucket: "saurusproject-6974b.firebasestorage.app",
    messagingSenderId: "519472343742",
    appId: "1:519472343742:web:xxxxxxxxxxxxxxxx" // ganti kalau punya appId web
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();

  let namaUser = '';
  let roomSaatIni = null;
  let sedangRekam = false;
  let recorder, chunksAudio = [];

  // Login
  function masuk() {
    namaUser = document.getElementById('nama').value.trim();
    if (!namaUser) return alert('Nama wajib diisi!');
    
    auth.signInAnonymously().then(() => {
      document.getElementById('login').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      tampilDaftarRoom();
    }).catch(err => alert('Gagal masuk: ' + err.message));
  }

  // Logout
  function keluar() {
    if (confirm('Yakin logout?')) {
      auth.signOut().then(() => location.reload());
    }
  }

  // Tampil daftar room
  function tampilDaftarRoom(kataCari = '') {
    const roomRef = db.ref('rooms');
    roomRef.once('value').then(snapshot => {
      const list = document.getElementById('daftar-room');
      list.innerHTML = '';
      const rooms = snapshot.val() || {};

      Object.keys(rooms).forEach(id => {
        const r = rooms[id];
        if (kataCari && !r.nama.toLowerCase().includes(kataCari.toLowerCase())) return;

        const div = document.createElement('div');
        div.className = 'room-item';
        div.innerHTML = `<strong>${r.nama}</strong><br><small>Max: ${r.max || '‚àû'}</small>`;
        div.onclick = () => gabungRoom(id, r.password);
        list.appendChild(div);
      });
    });
  }

  function cariRoom() {
    tampilDaftarRoom(document.getElementById('cari').value);
  }

  // Form buat room
  function tampilBuatRoom() {
    document.getElementById('form-buat').classList.remove('hidden');
  }
  function sembunyiBuatRoom() {
    document.getElementById('form-buat').classList.add('hidden');
  }

  function buatRoom() {
    const nama = document.getElementById('nama-room').value.trim();
    const pw = document.getElementById('pw-room').value;
    const max = parseInt(document.getElementById('max-anggota').value) || null;

    if (!nama) return alert('Nama room wajib!');
    
    const id = db.ref('rooms').push().key;
    db.ref('rooms/' + id).set({
      nama,
      password: pw || null,
      max,
      dibuat: firebase.database.ServerValue.TIMESTAMP
    });

    sembunyiBuatRoom();
    tampilDaftarRoom();
  }

  // Gabung room
  function gabungRoom(id, pwDiperlukan) {
    if (pwDiperlukan) {
      const inputPw = prompt('Room ini pakai password. Masukkan:');
      if (inputPw !== pwDiperlukan) return alert('Password salah!');
    }

    roomSaatIni = id;
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('chat').classList.remove('hidden');
    document.getElementById('nama-room-saatini').textContent = 'Room: ' + id;

    mulaiDengarChat();
  }

  function kembaliDashboard() {
    roomSaatIni = null;
    document.getElementById('chat').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    tampilDaftarRoom();
  }

  // Dengar chat real-time
  function mulaiDengarChat() {
    const chatRef = db.ref('rooms/' + roomSaatIni + '/pesan');
    chatRef.on('child_added', snapshot => {
      const msg = snapshot.val();
      tambahPesan(msg);
    });
  }

  function tambahPesan(msg) {
    const container = document.getElementById('pesan-container');
    const div = document.createElement('div');
    div.className = `pesan ${msg.pengirim === namaUser ? 'kirim' : 'terima'}`;

    let pengirimDisplay = msg.pengirim;
    if (msg.pengirim.toLowerCase().includes('saurus')) {
      pengirimDisplay += ' <span class="owner-badge">OWNER</span>';
    }

    let isi = `<span class="pengirim">${pengirimDisplay} ‚Ä¢ ${new Date(msg.waktu).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'})}</span>`;
    
    if (msg.tipe === 'teks') isi += msg.isi;
    else if (msg.tipe === 'gambar') isi += `<img src="${msg.isi}" alt="Gambar">`;
    else if (msg.tipe === 'suara') isi += `<audio controls src="${msg.isi}"></audio>`;
    
    div.innerHTML = isi;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  // Kirim teks
  document.getElementById('kirim').onclick = () => {
    const teks = document.getElementById('input-pesan').value.trim();
    if (!teks) return;
    db.ref('rooms/' + roomSaatIni + '/pesan').push({
      pengirim: namaUser,
      tipe: 'teks',
      isi: teks,
      waktu: firebase.database.ServerValue.TIMESTAMP
    });
    document.getElementById('input-pesan').value = '';
  };

  document.getElementById('input-pesan').onkeypress = e => {
    if (e.key === 'Enter') document.getElementById('kirim').click();
  };

  // Gambar
  document.getElementById('upload-gambar').onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const storageRef = storage.ref('gambar/' + Date.now() + '_' + file.name);
    storageRef.put(file).then(() => storageRef.getDownloadURL()).then(url => {
      db.ref('rooms/' + roomSaatIni + '/pesan').push({
        pengirim: namaUser,
        tipe: 'gambar',
        isi: url,
        waktu: firebase.database.ServerValue.TIMESTAMP
      });
    });
  };

  // Voice note
  document.getElementById('rekam').onclick = async () => {
    if (sedangRekam) return;
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recorder = new MediaRecorder(stream);
      chunksAudio = [];

      recorder.ondataavailable = e => chunksAudio.push(e.data);
      recorder.onstop = async () => {
        const blob = new Blob(chunksAudio, { type: 'audio/webm' });
        const storageRef = storage.ref('suara/' + Date.now() + '.webm');
        await storageRef.put(blob);
        const url = await storageRef.getDownloadURL();

        db.ref('rooms/' + roomSaatIni + '/pesan').push({
          pengirim: namaUser,
          tipe: 'suara',
          isi: url,
          waktu: firebase.database.ServerValue.TIMESTAMP
        });
      };

      recorder.start();
      sedangRekam = true;
      document.getElementById('rekam-ui').classList.remove('hidden');

      document.getElementById('stop-rekam').onclick = () => {
        recorder.stop();
        sedangRekam = false;
        document.getElementById('rekam-ui').classList.add('hidden');
      };
    } catch (err) {
      alert('Gagal akses mikrofon: ' + err.message);
    }
  };
</script>
</body>
</html>
